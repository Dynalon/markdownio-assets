<!DOCTYPE html>
<html>
    
    <head>
        <title>
            MDX Prototype
        </title>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.0.min.js">
        </script>
        <script type="text/javascript" src="js/jquery-tiggle-plugin.js">
        </script>
        <script type="text/javascript" src="js/jquery-shorturl-plugin.js">
        </script>
        <!-- <script type="text/javascript" src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.0.4/js/bootstrap.min.js"></script>
		<link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.0.4/css/bootstrap-combined.min.css" />
-->
        <script type="text/javascript" src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.1.0/js/bootstrap.min.js">
        </script>
        <link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.1.0/css/bootstrap.min.css"
        />
        <script type="text/javascript">
        		// no trailing / !
		var gateway_base_url = "http://127.0.0.1:8080";
		var default_document_url = "http://i08fs1.ira.uka.de/~s_drr/cafe/index.txt";

		var gateway_url;

		var page_options = {
		    "theme": "spacelab",
		    "s": 1,
		    "m": 1,
		    "t": 1
		}

		var preview_window = null;
		// take the url to the markdown and constructs a gateway url
		 // @param options	an object holding the parameters for the theme, menu etc.


		function update() {
		    $('#preview').fadeOut('fast');

            $("#short_url")
                .val('')
                .attr('placeholder', "click me to get a short url");

		    // construct the url
		    var url = gateway_base_url + "/";
		    // apply options and encode into url
		    $.each(page_options, function(key, val) {
		        url += "_" + key + "=" + val + "/";
		    });
		    url += $("#long_url").val();

		    gateway_url = url;
		    $("#preview").attr('src', gateway_url);

		    if (preview_window !== null) {
		        preview_window.location.href = gateway_url;
		    }
		}

		function init_get_url() {
		    // TODO more robust method, maybe use "jqeruy address" plugin
		    var this_pages_url = window.location.href;
		    var i = window.location.href.indexOf("url=");

		    var document_url;
		    if (i < 0)
		    // no url set, use a default one
		    document_url = default_document_url;
		    else
		    // grab all parts after url=
		    document_url = this_pages_url.substr(i + 4, 4096);

		    return document_url;
		}

		$(document).ready(function() {
		    $(".tiggle").tiggle();
		    $("#long_url").val(init_get_url());

		    /* $("#long_url").change(function() {
		      update();
		    }); */

		    $("#short_url").click(function() {
                $this = $(this);
               
               // gray out the input field 
                $this.val ('loading..')
                    .attr ('disabled', true);

                $.get_short_url (gateway_url, function(data, status) {
                    if (data.ErrorCode == 0) {
                        $this.val (data.ShortUrl);
                        $this.removeAttr ('disabled');
                    }
                });
		    });
            // focus text field upon click/select 
            $("input[type=text]").bind ('click focus', function(){
                // Select field contents
                this.select();
            });

		    // trigger the callback one time on load
		    update();

		    $("#open_preview_button").click(function() {
		        preview_window = window.open(gateway_url, "preview_window");
		    });

		    $("#preview").load(function() {
		        $(this).fadeIn('fast');
		    });

		    //			$('[rel=popover]').popover ({ placement: 'bottom' });
		    $(".navbar").button();

		    // get the themes as a list via JSON
		    $.ajax({
		        url: "http://127.0.0.1:8080/api/themes/?format=json&callback=?",
		        dataType: 'jsonp',
		    }).done(function(data, status) {
		        $(data.AvailableThemes).each(function(index, theme) {
		            // set the img source
		            var img_src = theme.PreviewImage;
		            var thumb = $("<img />").attr("src", img_src)
		            // .wrap cannot work on elements without parents so FIRST append it
		            // THEN wrap
		            .appendTo("#theme_thumbnails")
		            // wrap then in an anchor for nice display
		            .wrap("<li class='span2' />").wrap("<a href='#' alt='" + theme.Name + "' class='thumbnail' />").click(function() {
		                page_options.theme = theme.Name;
		                update();
		            });
		            // finall add the image to the DOM
		        });
		    });
		    // get short url
		});
        </script>
    </head>
    
    <body style="margin-top: 80px;">
        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="brand" href="#"> MDX </a>
                    <div class="span11">
                        <form class="navbar-form ">
                            <div class="row">
                                <div class="input-prepend">
                                    <span class="add-on">
                                        Your Markdown URL:
                                    </span>
                                    <input type="text" id="long_url" class="span3" />
                                </preview_div>
                           
                                <div class="input-prepend">
                                    <span class="add-on">
                                        Short URL:
                                    </span><input type="text" id="short_url" class="span3" />
                                    <button class="btn btn-primary tiggle" data-toggle="button">
                                        Menu
                                    </button>
                                    <button class="btn btn-primary tiggle" data-toggle="button">
                                        Title
                                    </button>
                                </div>
                            </div>
                        </form>
                        <ul class="nav">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
								Account
								<b class="caret"></b>	
							</a>
                                <ul class="dropdown-menu">
                                    <form>
                                        <li>
                                            <a href="#">foo</a>
                                        </li>
                                        <li>
                                            <a href="#">foo</a>
                                        </li>
                                    </form>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <!-- offset1 div> -->
                </div>
                <!-- container -->
            </div>
            <!-- navbar-inner -->
        </div>
        <!-- navbar -->
        <div class="container">
            <div class="row">
                <!-- micro hero unit-->
                <div class="span12">
                    <div class="well">
                        <h1>
                            Preview your Page
                        </h1>
                        <p>
                            Select a theme for your page on the right and see how it will look!
                        </p>
                        <p>
                            <a class="btn btn-primary" href="#" id="open_preview_button">Open preview in new window</a>
                        </p>
                    </div>
                    <!-- well -->
                </div>
                <!-- span12 -->
            </div>
            <!-- row -->
            <!-- preview & theme thumbnails row -->
            <div class="row">
                <div class="span10">
                    <div id="#preview_div" style="padding: 1px; width: 100%; border: 1px dotted gray; height: 1202px;">
                        <iframe id="preview" width="100%" src="" style="height:1200px; border: 0px solid black;">
                        </iframe>
                    </div>
                </div>
                <!-- theme thumbnails -->
                <div class="span2" id="themes">
                    <center>
                        <h4>
                            Click on a theme to apply:
                        </h4>
                    </center>
                    <ul class="thumbnails" id="theme_thumbnails">
                    </ul>
                </div>
                <!-- end theme thumbnails -->
            </div>
            <!-- preview & theme thumbnails row -->
    </body>

</html>